{% extends "base.html" %}

{% block title %}WSPR Antenna Comparison{% endblock %}

{% block head %}
<style>
    .compare-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }
    .compare-stats {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
        margin-bottom: 2rem;
    }
    .antenna-card {
        background: #1e1e1e;
        border-radius: 8px;
        padding: 1.5rem;
    }
    .antenna-card h3 {
        margin: 0 0 0.5rem 0;
        color: #4fc3f7;
    }
    .antenna-card.ant-80ef1 { border-left: 4px solid #ff9800; }
    .antenna-card.ant-ryb { border-left: 4px solid #4caf50; }
    .stat-row {
        display: flex;
        justify-content: space-between;
        padding: 0.25rem 0;
        border-bottom: 1px solid #333;
    }
    .stat-label { color: #888; }
    .stat-value { font-weight: bold; }

    .band-comparison {
        margin-top: 2rem;
    }
    .band-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
    }
    .band-table th, .band-table td {
        padding: 0.75rem;
        text-align: center;
        border-bottom: 1px solid #333;
    }
    .band-table th {
        background: #2a2a2a;
        font-weight: 600;
    }
    .winner-80ef1 { color: #ff9800; font-weight: bold; }
    .winner-ryb { color: #4caf50; font-weight: bold; }
    .winner-tie { color: #888; }

    .direction-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 0.5rem;
        max-width: 300px;
        margin: 1rem auto;
    }
    .direction-cell {
        padding: 0.5rem;
        text-align: center;
        background: #2a2a2a;
        border-radius: 4px;
    }
    .direction-cell.center {
        background: transparent;
    }
    .dir-label { font-size: 0.8rem; color: #888; }
    .dir-value { font-weight: bold; }
    .dir-positive { color: #4caf50; }
    .dir-negative { color: #ff9800; }

    .caveat-box {
        background: #2a2a2a;
        border-left: 4px solid #ffc107;
        padding: 1rem;
        margin: 1rem 0;
    }
    .caveat-box h4 {
        margin: 0 0 0.5rem 0;
        color: #ffc107;
    }

    .refresh-info {
        color: #666;
        font-size: 0.85rem;
    }
    .loading { opacity: 0.5; }
</style>
{% endblock %}

{% block content %}
<div class="compare-page">
    <div class="compare-header">
        <div>
            <h1>WSPR Antenna Comparison</h1>
            <p class="subtitle">80ef1 (EFHW) vs ryb (Rybakov) - Live from wspr.live</p>
        </div>
        <div class="refresh-info">
            <span id="last-refresh">Loading...</span>
            <button onclick="loadComparison()" class="btn btn-small">Refresh</button>
        </div>
    </div>

    <div class="caveat-box">
        <h4>Data Collection In Progress</h4>
        <p id="caveat-text">Comparison accuracy improves as more data is collected for both antennas under similar conditions.</p>
    </div>

    <div class="compare-stats" id="antenna-stats">
        <div class="antenna-card ant-80ef1">
            <h3>80ef1 (EFHW)</h3>
            <p style="color:#888; font-size:0.85rem;">80m EFHW, vertical to 30', wire WSW/NNW</p>
            <div class="stat-row">
                <span class="stat-label">Total Spots</span>
                <span class="stat-value" id="80ef1-total">-</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Matched Spots</span>
                <span class="stat-value" id="80ef1-matched">-</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Time Range</span>
                <span class="stat-value" id="80ef1-time">-</span>
            </div>
        </div>
        <div class="antenna-card ant-ryb">
            <h3>ryb (Rybakov)</h3>
            <p style="color:#888; font-size:0.85rem;">25ft vertical whip, 4:1 unun</p>
            <div class="stat-row">
                <span class="stat-label">Total Spots</span>
                <span class="stat-value" id="ryb-total">-</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Matched Spots</span>
                <span class="stat-value" id="ryb-matched">-</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Time Range</span>
                <span class="stat-value" id="ryb-time">-</span>
            </div>
        </div>
    </div>

    <div class="card band-comparison">
        <h2>Band Comparison (Time-Matched)</h2>
        <p class="text-muted">Only comparing data from same UTC hours to reduce propagation bias</p>
        <table class="band-table">
            <thead>
                <tr>
                    <th>Band</th>
                    <th>80ef1 SNR</th>
                    <th>ryb SNR</th>
                    <th>Delta</th>
                    <th>Winner</th>
                </tr>
            </thead>
            <tbody id="band-table-body">
                <tr><td colspan="5">Loading...</td></tr>
            </tbody>
        </table>
    </div>

    <div class="card">
        <h2>Direction Analysis (40m)</h2>
        <p class="text-muted">SNR delta by direction (positive = ryb better, negative = 80ef1 better)</p>
        <div class="direction-grid" id="direction-grid">
            <!-- Filled by JS -->
        </div>
    </div>

    <div class="card">
        <h2>Methodology</h2>
        <ul>
            <li><strong>Data source:</strong> wspr.live historical database</li>
            <li><strong>Time matching:</strong> Only hours where both antennas have data are compared</li>
            <li><strong>Antenna switch:</strong> Jan 25, 2026 4pm PST (Jan 26 00:00 UTC)</li>
            <li><strong>Limitation:</strong> Different days may have different propagation conditions</li>
        </ul>
        <p class="text-muted">For best results, compare data collected over similar time periods and solar conditions.</p>
    </div>
</div>

<script>
const BAND_NAMES = {0: '160m', 3: '80m', 5: '60m', 7: '40m', 10: '30m', 14: '20m', 18: '17m', 21: '15m', 24: '12m', 28: '10m'};

async function loadComparison() {
    document.getElementById('antenna-stats').classList.add('loading');

    try {
        const response = await fetch('{{ url_for("main.api_wspr_compare") }}');
        const data = await response.json();

        if (data.error) {
            alert('Error: ' + data.error);
            return;
        }

        // Update stats
        const a80 = data.antennas['80ef1'];
        const aryb = data.antennas['ryb'];

        document.getElementById('80ef1-total').textContent = a80.total_spots.toLocaleString();
        document.getElementById('80ef1-matched').textContent = a80.matched_spots.toLocaleString();
        document.getElementById('80ef1-time').textContent = a80.time_range ?
            `${a80.time_range[0].slice(5,10)} to ${a80.time_range[1].slice(5,10)}` : '-';

        document.getElementById('ryb-total').textContent = aryb.total_spots.toLocaleString();
        document.getElementById('ryb-matched').textContent = aryb.matched_spots.toLocaleString();
        document.getElementById('ryb-time').textContent = aryb.time_range ?
            `${aryb.time_range[0].slice(5,10)} to ${aryb.time_range[1].slice(5,10)}` : '-';

        // Update caveat
        const ratio = aryb.total_spots / (a80.total_spots || 1);
        if (ratio < 0.1) {
            document.getElementById('caveat-text').textContent =
                `ryb has only ${(ratio * 100).toFixed(1)}% as much data as 80ef1. Results are preliminary.`;
        } else if (ratio < 0.5) {
            document.getElementById('caveat-text').textContent =
                `ryb has ${(ratio * 100).toFixed(0)}% as much data as 80ef1. More data will improve accuracy.`;
        } else {
            document.getElementById('caveat-text').textContent =
                `Good data balance. Comparison should be reasonably accurate.`;
        }

        // Build band table
        const allBands = new Set([
            ...Object.keys(a80.by_band).map(Number),
            ...Object.keys(aryb.by_band).map(Number)
        ]);

        let tableHtml = '';
        [...allBands].sort((a,b) => a-b).forEach(band => {
            const b80 = a80.by_band[band];
            const bryb = aryb.by_band[band];

            const snr80 = b80?.avg_snr;
            const snrryb = bryb?.avg_snr;

            let delta = null, winner = '-', winnerClass = '';
            if (snr80 !== null && snr80 !== undefined && snrryb !== null && snrryb !== undefined) {
                delta = snrryb - snr80;
                if (delta > 1) { winner = 'ryb'; winnerClass = 'winner-ryb'; }
                else if (delta < -1) { winner = '80ef1'; winnerClass = 'winner-80ef1'; }
                else { winner = '~tie'; winnerClass = 'winner-tie'; }
            } else if (snr80 !== null && snr80 !== undefined) {
                winner = '80ef1 only';
            } else if (snrryb !== null && snrryb !== undefined) {
                winner = 'ryb only';
            }

            tableHtml += `<tr>
                <td>${BAND_NAMES[band] || band + 'm'}</td>
                <td>${snr80 !== null && snr80 !== undefined ? snr80.toFixed(1) + 'dB' : '-'}</td>
                <td>${snrryb !== null && snrryb !== undefined ? snrryb.toFixed(1) + 'dB' : '-'}</td>
                <td>${delta !== null ? (delta >= 0 ? '+' : '') + delta.toFixed(1) + 'dB' : '-'}</td>
                <td class="${winnerClass}">${winner}</td>
            </tr>`;
        });
        document.getElementById('band-table-body').innerHTML = tableHtml;

        // Direction grid
        const dirs = ['NW', 'N', 'NE', 'W', '', 'E', 'SW', 'S', 'SE'];
        const dir80 = a80.by_direction_40m || {};
        const dirryb = aryb.by_direction_40m || {};

        let dirHtml = '';
        dirs.forEach(d => {
            if (d === '') {
                dirHtml += '<div class="direction-cell center">40m</div>';
            } else {
                const s80 = dir80[d];
                const sryb = dirryb[d];
                let delta = null, deltaClass = '';
                if (s80 !== null && s80 !== undefined && sryb !== null && sryb !== undefined) {
                    delta = sryb - s80;
                    deltaClass = delta > 0 ? 'dir-positive' : 'dir-negative';
                }
                dirHtml += `<div class="direction-cell">
                    <div class="dir-label">${d}</div>
                    <div class="dir-value ${deltaClass}">${delta !== null ? (delta >= 0 ? '+' : '') + delta.toFixed(1) : '-'}</div>
                </div>`;
            }
        });
        document.getElementById('direction-grid').innerHTML = dirHtml;

        // Update refresh time
        document.getElementById('last-refresh').textContent =
            'Updated: ' + new Date(data.generated).toLocaleTimeString();

    } catch (error) {
        console.error('Failed to load comparison:', error);
        alert('Failed to load comparison data');
    } finally {
        document.getElementById('antenna-stats').classList.remove('loading');
    }
}

// Load on page load
loadComparison();

// Auto-refresh every 15 minutes
setInterval(loadComparison, 15 * 60 * 1000);
</script>
{% endblock %}
