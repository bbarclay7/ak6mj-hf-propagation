{% extends "base.html" %}

{% block title %}WSPR - Antenna Comparison{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
    #map {
        height: 500px;
        width: 100%;
        margin-bottom: 2rem;
    }
    .wspr-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }
    .stat-card {
        background: #f5f5f5;
        padding: 1rem;
        border-radius: 4px;
        text-align: center;
    }
    .stat-value {
        font-size: 2rem;
        font-weight: bold;
        color: #2563eb;
    }
    .stat-label {
        color: #666;
        font-size: 0.9rem;
        margin-top: 0.5rem;
    }
    .spots-table {
        width: 100%;
        border-collapse: collapse;
    }
    .spots-table th,
    .spots-table td {
        padding: 0.75rem;
        text-align: left;
        border-bottom: 1px solid #e5e7eb;
    }
    .spots-table th {
        background: #f9fafb;
        font-weight: 600;
    }
    .snr-good { color: #16a34a; }
    .snr-ok { color: #ca8a04; }
    .snr-weak { color: #dc2626; }
    .tx-location {
        font-weight: 600;
        color: #2563eb;
    }
    #antenna-selector {
        display: flex;
        gap: 2rem;
        align-items: start;
        flex-wrap: wrap;
    }
    .antenna-info {
        flex: 1;
        min-width: 300px;
    }
    .antenna-name {
        font-size: 1.5rem;
        font-weight: bold;
        color: #4fc3f7;
        margin-bottom: 0.5rem;
    }
    .antenna-desc {
        color: #aaa;
        margin-bottom: 0.5rem;
        line-height: 1.6;
    }
    .antenna-updated {
        font-size: 0.85rem;
        color: #666;
    }
    .antenna-controls {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        min-width: 300px;
    }
    .antenna-controls select {
        flex: 1;
    }
    .stat-detail {
        font-size: 0.75rem;
        color: #888;
        margin-top: 0.25rem;
    }
    .beacon-active { border-left: 4px solid #16a34a; }
    .beacon-stale { border-left: 4px solid #ca8a04; }
    .beacon-offline { border-left: 4px solid #dc2626; }
</style>
{% endblock %}

{% block content %}
<div class="wspr-page">
    <h1>WSPR Beacon Monitoring</h1>
    <p class="subtitle">Propagation tracking for AK6MJ beacon | <a href="{{ url_for('main.wspr_compare_page') }}">Antenna Comparison</a></p>

    <div class="card">
        <h2>Current Antenna</h2>
        <div id="antenna-selector">
            <div class="antenna-info" id="antenna-info">
                <div class="antenna-name" id="antenna-name">Loading...</div>
                <div class="antenna-desc" id="antenna-desc"></div>
                <div class="antenna-updated" id="antenna-updated"></div>
            </div>
            <div class="antenna-controls">
                <select id="antenna-select" class="form-control">
                    <option value="">Select antenna...</option>
                </select>
                <button id="update-antenna-btn" class="btn btn-primary btn-small" onclick="updateWSPRAntenna()">Update</button>
            </div>
        </div>
    </div>

    <div class="wspr-stats" id="stats">
        <div class="stat-card" id="beacon-status-card">
            <div class="stat-value" id="stat-band">-</div>
            <div class="stat-label">Beacon Band</div>
            <div class="stat-detail" id="stat-band-detail"></div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="stat-total">-</div>
            <div class="stat-label">Total Spots</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="stat-reporters">-</div>
            <div class="stat-label">Unique Reporters</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="stat-distance">-</div>
            <div class="stat-label">Max Distance (km)</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="stat-location">-</div>
            <div class="stat-label">TX Location</div>
        </div>
    </div>

    <div class="card">
        <h2>Propagation Map</h2>
        <div id="map"></div>
        <p class="text-muted" id="last-update">Loading...</p>
    </div>

    <div class="card">
        <h2>Recent Spots</h2>
        <div id="spots-container">
            <p>Loading spots...</p>
        </div>
    </div>
</div>

<script>
// Initialize map
const map = L.map('map').setView([38.5, -98.0], 4);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
}).addTo(map);

let txMarker = null;
let markers = [];

// Fetch and display WSPR data
async function loadWSPRData() {
    try {
        const response = await fetch('{{ url_for("main.api_wspr_spots") }}');
        const data = await response.json();

        // Clear existing markers
        markers.forEach(m => map.removeLayer(m));
        markers = [];
        if (txMarker) {
            map.removeLayer(txMarker);
            txMarker = null;
        }

        if (!data.spots || data.spots.length === 0) {
            document.getElementById('spots-container').innerHTML =
                '<p>No spots available. Beacon may be inactive or data not yet collected.</p>';
            document.getElementById('last-update').textContent =
                'Last updated: ' + (data.last_updated ? new Date(data.last_updated).toLocaleString() : 'Never');
            return;
        }

        // Update stats
        const uniqueReporters = new Set(data.spots.map(s => s.reporter)).size;
        const maxDistance = Math.max(...data.spots.map(s => s.distance_km || 0));

        document.getElementById('stat-total').textContent = data.spots.length;
        document.getElementById('stat-reporters').textContent = uniqueReporters;
        document.getElementById('stat-distance').textContent = Math.round(maxDistance);
        document.getElementById('stat-location').textContent = data.tx_grid || 'Unknown';
        document.getElementById('last-update').textContent =
            'Last updated: ' + new Date(data.last_updated).toLocaleString();

        // Add TX marker if we have grid
        if (data.tx_grid) {
            const txCoords = gridToLatLon(data.tx_grid);
            if (txCoords) {
                txMarker = L.marker(txCoords, {
                    icon: L.divIcon({
                        className: 'tx-marker',
                        html: '<div style="background: red; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white;"></div>'
                    })
                }).addTo(map).bindPopup(`<b>AK6MJ</b><br>${data.tx_grid}`);
                markers.push(txMarker);
            }
        }

        // Add reporter markers
        data.spots.forEach(spot => {
            const coords = gridToLatLon(spot.reporter_grid);
            if (coords) {
                const snrClass = spot.snr >= -15 ? 'snr-good' : spot.snr >= -25 ? 'snr-ok' : 'snr-weak';
                const marker = L.marker(coords).addTo(map).bindPopup(
                    `<b>${spot.reporter}</b><br>
                    Grid: ${spot.reporter_grid}<br>
                    SNR: <span class="${snrClass}">${spot.snr} dB</span><br>
                    Distance: ${Math.round(spot.distance_km)} km<br>
                    Bearing: ${spot.bearing_deg}°<br>
                    Frequency: ${spot.frequency} MHz<br>
                    Time: ${new Date(spot.timestamp).toLocaleString()}`
                );
                markers.push(marker);
            }
        });

        // Fit map to markers
        if (markers.length > 0) {
            const group = new L.featureGroup(markers);
            map.fitBounds(group.getBounds().pad(0.1));
        }

        // Build spots table
        let html = '<table class="spots-table"><thead><tr>';
        html += '<th>Time</th><th>Reporter</th><th>Grid</th><th>SNR</th><th>Distance</th><th>Bearing</th><th>Frequency</th>';
        html += '</tr></thead><tbody>';

        data.spots.forEach(spot => {
            const snrClass = spot.snr >= -15 ? 'snr-good' : spot.snr >= -25 ? 'snr-ok' : 'snr-weak';
            const time = new Date(spot.timestamp).toLocaleTimeString();
            html += `<tr>
                <td>${time}</td>
                <td>${spot.reporter}</td>
                <td>${spot.reporter_grid}</td>
                <td class="${snrClass}">${spot.snr} dB</td>
                <td>${Math.round(spot.distance_km)} km</td>
                <td>${spot.bearing_deg}°</td>
                <td>${spot.frequency} MHz</td>
            </tr>`;
        });

        html += '</tbody></table>';
        document.getElementById('spots-container').innerHTML = html;

    } catch (error) {
        console.error('Error loading WSPR data:', error);
        document.getElementById('spots-container').innerHTML =
            '<p class="error">Error loading WSPR data. Check console for details.</p>';
    }
}

// Maidenhead grid to lat/lon converter (supports 4 and 6 character grids)
function gridToLatLon(grid) {
    if (!grid || grid.length < 4) return null;

    grid = grid.toUpperCase();
    let lon = (grid.charCodeAt(0) - 65) * 20 - 180 + (grid.charCodeAt(2) - 48) * 2;
    let lat = (grid.charCodeAt(1) - 65) * 10 - 90 + (grid.charCodeAt(3) - 48);

    // Handle 6-char grids with subsquare
    if (grid.length >= 6) {
        lon += (grid.charCodeAt(4) - 65) * (2/24) + (1/24);
        lat += (grid.charCodeAt(5) - 65) * (1/24) + (1/48);
    } else {
        // For 4-char grids, return center of square
        lon += 1;
        lat += 0.5;
    }

    return [lat, lon];
}

// Load current WSPR antenna
async function loadWSPRAntenna() {
    try {
        const response = await fetch('{{ url_for("main.api_wspr_antenna_get") }}');
        const data = await response.json();

        if (data.antenna) {
            document.getElementById('antenna-name').textContent = data.antenna;
            document.getElementById('antenna-desc').textContent = data.description || '';
            if (data.last_updated) {
                const updated = new Date(data.last_updated);
                document.getElementById('antenna-updated').textContent =
                    'Updated: ' + updated.toLocaleString();
            }
        } else {
            document.getElementById('antenna-name').textContent = 'Not configured';
            document.getElementById('antenna-desc').textContent = '';
            document.getElementById('antenna-updated').textContent = '';
        }
    } catch (error) {
        console.error('Failed to load WSPR antenna:', error);
        document.getElementById('antenna-name').textContent = 'Error loading antenna';
    }
}

// Load available antennas for selector
async function loadAntennas() {
    try {
        const response = await fetch('{{ url_for("main.api_antennas_list") }}');
        const antennas = await response.json();

        const select = document.getElementById('antenna-select');
        select.innerHTML = '<option value="">Select antenna...</option>';

        for (const [label, info] of Object.entries(antennas)) {
            const option = document.createElement('option');
            option.value = label;
            option.textContent = `${label} - ${info.description.substring(0, 50)}...`;
            select.appendChild(option);
        }
    } catch (error) {
        console.error('Failed to load antennas:', error);
    }
}

// Update WSPR antenna
async function updateWSPRAntenna() {
    const select = document.getElementById('antenna-select');
    const antenna = select.value;

    if (!antenna) {
        alert('Please select an antenna');
        return;
    }

    const btn = document.getElementById('update-antenna-btn');
    btn.disabled = true;
    btn.textContent = 'Updating...';

    try {
        const response = await fetch('{{ url_for("main.api_wspr_antenna_set") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ antenna: antenna })
        });

        if (!response.ok) {
            throw new Error('Failed to update antenna');
        }

        // Reload antenna display
        await loadWSPRAntenna();

        // Reset selector
        select.value = '';
        alert('WSPR antenna updated successfully');

    } catch (error) {
        console.error('Failed to update antenna:', error);
        alert('Failed to update antenna: ' + error.message);
    } finally {
        btn.disabled = false;
        btn.textContent = 'Update';
    }
}

// Load beacon status (band, frequency, etc)
async function loadBeaconStatus() {
    const card = document.getElementById('beacon-status-card');
    const bandEl = document.getElementById('stat-band');
    const detailEl = document.getElementById('stat-band-detail');

    try {
        const response = await fetch('{{ url_for("main.api_wspr_beacon") }}');
        const data = await response.json();

        if (data.status === 'unknown' || data.error) {
            bandEl.textContent = '?';
            detailEl.textContent = 'Beacon offline or unreachable';
            card.className = 'stat-card beacon-offline';
        } else if (data.stale) {
            bandEl.textContent = data.band || '?';
            detailEl.textContent = `Stale (${Math.round(data.age_minutes)}min ago)`;
            card.className = 'stat-card beacon-stale';
        } else {
            bandEl.textContent = data.band;
            detailEl.textContent = `${data.pool} pool`;
            card.className = 'stat-card beacon-active';
        }
    } catch (error) {
        console.error('Failed to load beacon status:', error);
        bandEl.textContent = '?';
        detailEl.textContent = 'Error loading status';
        card.className = 'stat-card beacon-offline';
    }
}

// Load data on page load
loadBeaconStatus();
loadWSPRAntenna();
loadAntennas();
loadWSPRData();

// Refresh every 5 minutes
setInterval(loadWSPRData, 5 * 60 * 1000);
setInterval(loadBeaconStatus, 60 * 1000);  // Refresh beacon status every minute
</script>
{% endblock %}
