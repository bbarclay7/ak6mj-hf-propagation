<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Antenna Comparison{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    {% block head %}{% endblock %}
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">
            <a href="{{ url_for('main.index') }}">Antenna Compare</a>
        </div>
        <div class="nav-links">
            <a href="{{ url_for('main.antennas_page') }}" {% if request.endpoint == 'main.antennas_page' %}class="active"{% endif %}>Antennas</a>
            <span class="nav-divider">|</span>
            <a href="{{ url_for('main.index') }}" {% if request.endpoint == 'main.index' %}class="active"{% endif %}>FT8</a>
            <a href="{{ url_for('main.experiment_page') }}" {% if request.endpoint == 'main.experiment_page' %}class="active"{% endif %}>FT8 Test</a>
            <a href="{{ url_for('main.comparisons_page') }}" {% if request.endpoint == 'main.comparisons_page' %}class="active"{% endif %}>FT8 History</a>
            <span class="nav-divider">|</span>
            <a href="{{ url_for('main.wspr_page') }}" {% if request.endpoint == 'main.wspr_page' %}class="active"{% endif %}>WSPR</a>
            <a href="{{ url_for('main.wspr_compare_page') }}" {% if request.endpoint == 'main.wspr_compare_page' %}class="active"{% endif %}>WSPR Compare</a>
        </div>
    </nav>

    <main class="container">
        {% block content %}{% endblock %}
    </main>

    <script>
    // Wrap fetch to handle Basic Auth for write operations
    const originalFetch = window.fetch;
    window.fetch = async function(url, options = {}) {
        // Add credentials for same-origin requests
        if (!options.credentials) {
            options.credentials = 'same-origin';
        }

        const response = await originalFetch(url, options);

        // Handle 401 - use XMLHttpRequest to trigger browser's native auth prompt
        if (response.status === 401) {
            return new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                xhr.open(options.method || 'GET', url, true);
                xhr.withCredentials = true;

                // Copy headers
                if (options.headers) {
                    for (const [key, value] of Object.entries(options.headers)) {
                        xhr.setRequestHeader(key, value);
                    }
                }

                xhr.onload = function() {
                    // Create a Response-like object
                    resolve({
                        ok: xhr.status >= 200 && xhr.status < 300,
                        status: xhr.status,
                        json: () => Promise.resolve(JSON.parse(xhr.responseText)),
                        text: () => Promise.resolve(xhr.responseText)
                    });
                };
                xhr.onerror = () => reject(new Error('Network error'));
                xhr.send(options.body || null);
            });
        }

        return response;
    };
    </script>
    <script src="{{ url_for('static', filename='app.js') }}"></script>
    {% block scripts %}{% endblock %}
</body>
</html>
